<!-- app.component.html -->
<div class="container">
  <!-- Error Modal -->
  <div class="error-modal" *ngIf="showErrorModal" role="alertdialog" aria-labelledby="error-modal-title" aria-describedby="error-modal-desc">
    <div class="error-modal-content">
      <div class="error-modal-title" id="error-modal-title">
        ‚ö†Ô∏è B≈ÇƒÖd walidacji
      </div>
      <ul class="error-modal-list" id="error-modal-desc" aria-live="polite" aria-atomic="true">
        <li *ngFor="let error of errorMessages">{{ error }}</li>
      </ul>
      <button class="error-modal-button" (click)="closeErrorModal()" aria-label="Zamknij modal b≈Çƒôdu walidacji">Zamknij</button>
    </div>
  </div>

<header>
    <img src="/polish_eagle.svg" alt="Polish national eagle emblem - white eagle with crown on red shield, symbol of Poland" width="80" height="80">
  <div style="display: flex; align-items: center; justify-content: center; gap: 16px;">
    <h1>Portal Rzeczy Znalezionych</h1>
  </div>
  <p>dane.gov.pl - Szybkie udostƒôpnianie danych</p>
</header>

  <div class="content">
    <div class="progress-section">
      <div class="progress-container">
        <div class="progress-line">
          <div class="progress-fill" [style.width.%]="getProgress()"></div>
        </div>
        
        <div class="progress-steps" role="tablist" aria-label="Kroki formularza">
          <div *ngFor="let i of [1,2,3,4]" class="progress-step" [ngClass]="{'active': isStepActive(i), 'completed': isStepCompleted(i)}" role="tab" [attr.aria-selected]="isStepActive(i)" [attr.aria-current]="isStepActive(i) ? 'step' : false" [attr.aria-label]="'Krok ' + i + ' z 4: Dane ' + getStepName(i)">
            <div class="step-circle" aria-hidden="true">
              <span *ngIf="isStepCompleted(i)" class="step-checkmark">‚úì</span>
              <span *ngIf="!isStepCompleted(i)">{{ i }}</span>
            </div>
            <div class="step-label">
              <span *ngIf="i === 1">Dane samorzƒÖdu</span>
              <span *ngIf="i === 2">Dane przedmiotu</span>
              <span *ngIf="i === 3">Warunki odbioru</span>
              <span *ngIf="i === 4">Podsumowanie</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <form [formGroup]="form" aria-label="Formularz zg≈Çoszenia rzeczy znalezionej">
      <!-- KROK 1: Dane samorzƒÖdu -->
      <div class="wizard" *ngIf="currentStep === 1" role="region" aria-labelledby="step1-title">
        <h2 class="step-title" id="step1-title">Krok 1/4: Dane SamorzƒÖdu</h2>
        <p class="step-description">Uzupe≈Çnij podstawowe informacje o samorzƒÖdzie</p>
        
        <div class="form-row">
          <div class="form-group">
            <label for="municipalityType">Typ samorzƒÖdu <span aria-label="wymagane">*</span></label>
            <select 
              id="municipalityType" 
              formControlName="municipalityType"
              aria-required="true"
              aria-describedby="municipalityType-help"
              required>
              <option value="">Wybierz...</option>
              <option *ngFor="let type of municipalityTypes" [value]="type.value">
                {{ type.label }}
              </option>
            </select>
            <small id="municipalityType-help" style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
              Wska≈º typ samorzƒÖdu: miasto, gmina, powiat lub wojew√≥dztwo
            </small>
          </div>
        </div>

        <div class="form-group" style="position: relative;">
          <label for="municipalityName">Nazwa samorzƒÖdu <span aria-label="wymagane">*</span></label>
          <input 
            type="text" 
            id="municipalityName" 
            formControlName="municipalityName"
            placeholder="Zacznij pisaƒá nazwƒô... (np. Warszawa, Powiat krakowski)"
            (input)="onMunicipalityNameInput()"
            (focus)="onMunicipalityNameInput()"
            (blur)="hideAutocomplete()"
            autocomplete="off"
            aria-required="true"
            aria-describedby="municipalityName-help"
            [attr.aria-expanded]="showAutocomplete && filteredUnits.length > 0"
            aria-autocomplete="list"
            [attr.aria-controls]="showAutocomplete && filteredUnits.length > 0 ? 'autocomplete-list' : null"
            required>
          
          <!-- Lista autouzupe≈Çniania -->
          <div 
            *ngIf="showAutocomplete && filteredUnits.length > 0" 
            class="autocomplete-list"
            id="autocomplete-list"
            role="listbox"
            aria-label="Sugestie samorzƒÖd√≥w">
            <div 
              *ngFor="let unit of filteredUnits; let idx = index" 
              class="autocomplete-item"
              [id]="'autocomplete-' + idx"
              role="option"
              [attr.aria-selected]="false"
              (click)="selectUnit(unit)"
              (keydown.enter)="selectUnit(unit)"
              (keydown.space)="selectUnit(unit)"
              tabindex="0">
              <strong>{{ unit.name }}</strong>
              <span class="autocomplete-type" aria-hidden="true">{{ unit.type }}</span>
              <span class="autocomplete-context" *ngIf="unit.parentName" aria-hidden="true">
                woj. {{ unit.parentName }}
              </span>
            </div>
          </div>
          
          <small id="municipalityName-help" style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
            üí° Wybierz najpierw typ samorzƒÖdu, nastƒôpnie zacznij pisaƒá nazwƒô aby zobaczyƒá podpowiedzi
          </small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="contactEmail">Email kontaktowy <span aria-label="wymagane">*</span></label>
            <input 
              type="email" 
              id="contactEmail" 
              formControlName="contactEmail"
              placeholder="kontakt@samorzad.pl"
              aria-required="true"
              aria-describedby="contactEmail-help"
              required>
            <small id="contactEmail-help" style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
              ‚ú® Email uzupe≈Çni siƒô automatycznie po wybraniu urzƒôdu (mo≈ºesz edytowaƒá)
            </small>
          </div>
        </div>

        <div class="buttons">
          <button type="button" class="btn-primary" (click)="nextStep()" aria-label="Przejd≈∫ do kroku drugiego - dane przedmiotu">Dalej ‚Üí</button>
        </div>
      </div>

      <!-- KROK 2: Dane przedmiotu -->
      <div class="wizard" *ngIf="currentStep === 2" role="region" aria-labelledby="step2-title">
        <h2 class="step-title" id="step2-title">Krok 2/4: Dodaj Rzecz ZnalezionƒÖ</h2>
        <p class="step-description">Wpisz szczeg√≥≈Çy znalezionego przedmiotu</p>
        
        <div class="form-group">
          <label for="itemName">Nazwa przedmiotu <span aria-label="wymagane">*</span></label>
          <input 
            type="text" 
            id="itemName" 
            formControlName="itemName"
            placeholder="np. Czarny portfel"
            aria-required="true"
            required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="itemCategory">Kategoria <span aria-label="wymagane">*</span></label>
            <select 
              id="itemCategory" 
              formControlName="itemCategory"
              aria-required="true"
              required>
              <option value="">Wybierz kategoriƒô...</option>
              <option *ngFor="let cat of categories" [value]="cat.value">
                {{ cat.label }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label for="itemDate">Data znalezienia <span aria-label="wymagane">*</span></label>
            <input 
              type="date" 
              id="itemDate" 
              formControlName="itemDate"
              aria-required="true"
              required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="itemLocation">Miejsce znalezienia <span aria-label="wymagane">*</span></label>
            <input 
              type="text" 
              id="itemLocation" 
              formControlName="itemLocation"
              placeholder="np. Przystanek autobusowy ul. Marsza≈Çkowska"
              aria-required="true"
              required>
          </div>
          <div class="form-group">
            <label for="itemStatus">Status <span aria-label="wymagane">*</span></label>
            <select 
              id="itemStatus" 
              formControlName="itemStatus"
              aria-required="true"
              required>
              <option value="">Wybierz status...</option>
              <option *ngFor="let status of statusOptions" [value]="status.value">
                {{ status.label }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="itemDescription">Opis szczeg√≥≈Çowy</label>
          <textarea 
            id="itemDescription" 
            formControlName="itemDescription"
            placeholder="Dodatkowe szczeg√≥≈Çy, znaki szczeg√≥lne, itp."></textarea>
        </div>

        <div class="buttons">
          <button type="button" class="btn-secondary" (click)="prevStep()" aria-label="Wr√≥ƒá do poprzedniego kroku - dane samorzƒÖdu">‚Üê Wstecz</button>
          <button type="button" class="btn-primary" (click)="nextStep()" aria-label="Przejd≈∫ do kroku trzeciego - warunki odbioru">Dalej ‚Üí</button>
        </div>
      </div>

      <!-- KROK 3: Warunki odbioru -->
      <div class="wizard" *ngIf="currentStep === 3" role="region" aria-labelledby="step3-title">
        <h2 class="step-title" id="step3-title">Krok 3/4: Warunki Odbioru</h2>
        <p class="step-description">Podaj informacje o warunkach przechowywania i odbioru</p>
        
        <div class="form-row">
          <div class="form-group">
            <label for="storageDeadline">Termin przechowywania (dni) <span aria-label="wymagane">*</span></label>
            <input 
              type="number" 
              id="storageDeadline" 
              formControlName="storageDeadline"
              min="1" 
              max="365" 
              aria-required="true"
              required>
          </div>
          <div class="form-group">
            <label for="pickupLocation">Miejsce odbioru <span aria-label="wymagane">*</span></label>
            <input 
              type="text" 
              id="pickupLocation" 
              formControlName="pickupLocation"
              placeholder="np. Biuro Stanu Cywilnego, ul. Marsza≈Çkowska 5"
              aria-required="true"
              required>
          </div>
        </div>

        <div class="form-group">
          <label for="pickupHours">Godziny dostƒôpno≈õci</label>
          <input 
            type="text" 
            id="pickupHours" 
            formControlName="pickupHours"
            placeholder="np. Pn-Pt 8:00-16:00">
        </div>

        <div class="form-group">
          <label for="contactPerson">Osoba do kontaktu</label>
          <input 
            type="text" 
            id="contactPerson" 
            formControlName="contactPerson"
            placeholder="Imiƒô i nazwisko">
        </div>

        <div class="buttons">
          <button type="button" class="btn-secondary" (click)="prevStep()" aria-label="Wr√≥ƒá do poprzedniego kroku - dane przedmiotu">‚Üê Wstecz</button>
          <button type="button" class="btn-primary" (click)="nextStep()" aria-label="Przejd≈∫ do kroku czwartego - podsumowanie">Dalej ‚Üí</button>
        </div>
      </div>

      <!-- KROK 4: Podsumowanie -->
      <div class="wizard" *ngIf="currentStep === 4" role="region" aria-labelledby="step4-title">
        <h2 class="step-title" id="step4-title">Krok 4/4: Podsumowanie i Udostƒôpnienie</h2>
        <p class="step-description">Przejrzyj dane i wybierz format eksportu</p>
        
        <div class="summary">
          <div class="summary-item">
            <span class="summary-label">SamorzƒÖd:</span>
            <span class="summary-value">{{ form.get('municipalityName')?.value }} ({{ form.get('municipalityType')?.value }})</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Przedmiot:</span>
            <span class="summary-value">{{ form.get('itemName')?.value }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Kategoria:</span>
            <span class="summary-value">{{ form.get('itemCategory')?.value }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Data znalezienia:</span>
            <span class="summary-value">{{ form.get('itemDate')?.value }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Miejsce znalezienia:</span>
            <span class="summary-value">{{ form.get('itemLocation')?.value }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Odbi√≥r:</span>
            <span class="summary-value">{{ form.get('pickupLocation')?.value }}</span>
          </div>
        </div>

        <p style="font-weight: 500; margin-bottom: 12px;">Wybierz format eksportu:</p>
        <div class="export-buttons">
          <button type="button" class="btn-primary" (click)="exportJSON()" aria-label="Pobierz dane w formacie JSON">üìÑ Pobierz JSON</button>
          <button type="button" class="btn-primary" (click)="exportCSV()" aria-label="Pobierz dane w formacie CSV">üìä Pobierz CSV</button>
        </div>

        <div style="background: #f0f7ff; border: 1px solid #b3d9ff; border-radius: 8px; padding: 15px; margin-top: 20px; margin-bottom: 20px; max-height: 200px; overflow-y: auto;">
          <p style="font-size: 12px; font-weight: 600; color: #003399; margin-bottom: 10px;">Preview JSON:</p>
          <pre style="font-size: 11px; color: #333; margin: 0; font-family: 'Courier New', monospace; white-space: pre-wrap; word-break: break-word;">{{ getFormDataPreview() }}</pre>
        </div>

        <div class="buttons">
          <button type="button" class="btn-secondary" (click)="prevStep()" aria-label="Wr√≥ƒá do poprzedniego kroku - warunki odbioru">‚Üê Wstecz</button>
          <button type="button" class="btn-primary" (click)="submitData()" aria-label="Wy≈õlij dane i udostƒôpnij w portalu">‚úì Udostƒôpnij w portalu</button>
        </div>
      </div>
    </form>

    <!-- Lista wgranych rekord√≥w -->
    <div *ngIf="items.length > 0" class="records-section" role="region" aria-labelledby="records-title">
      <h3 id="records-title">üìã Dodane rekordy ({{ items.length }})</h3>
      <div *ngFor="let item of items; let idx = index" class="record-item" role="article" [attr.aria-label]="'Rekord ' + (idx + 1) + ': ' + item.item.name + ' znalezione w ' + item.municipality.name">
        <div>
          <strong>{{ item.item.name }}</strong>
          <span style="color: #999; font-size: 13px; margin-left: 8px;">{{ item.item.date }}</span>
        </div>
        <div style="font-size: 13px; color: #666; margin-top: 8px;">
          üèõÔ∏è {{ item.municipality.name }} ‚Ä¢ üìç {{ item.item.location }}
        </div>
        <div style="font-size: 12px; color: #999; margin-top: 6px;">
          ID: {{ item.id }}
        </div>
      </div>
    </div>
  </div>
</div>